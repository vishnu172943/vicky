<script>
  const apiKey = 'AIzaSyAPuyc1O1jKBi0KawKmi_jeExdwiHq7PXU'; // **IMPORTANT: Keep API keys secure in real applications!**
  const modelName = 'gemini-2.0-flash';
  const chatDisplay = document.getElementById('chat-display');
  const messageInput = document.getElementById('message-input');
  const sendButton = document.getElementById('send-button');

  const followUpPopup = document.getElementById('followUpPopup');
  const followUpQuestionList = document.getElementById('followUpQuestionList');
  const popupCloseBtn = document.getElementById('popupCloseBtn');

  let conversationHistory = []; // Array to store conversation history

  sendButton.addEventListener('click', sendMessage);
  messageInput.addEventListener('keydown', (event) => {
    if (event.key === 'Enter' && !event.shiftKey) {
      event.preventDefault();
      sendMessage();
    }
  });

  popupCloseBtn.onclick = function() {
    followUpPopup.style.display = "none"; // Close popup when close button is clicked
  }

  window.onclick = function(event) {
    if (event.target == followUpPopup) {
      followUpPopup.style.display = "none"; // Close popup if clicked outside the content
    }
  }


  async function sendMessage() {
    const userMessageText = messageInput.value.trim();
    if (!userMessageText) return;

    displayUserMessage(userMessageText);

    // Add user message to conversation history
    conversationHistory.push({ role: 'user', parts: [{ text: userMessageText }] });
    if (conversationHistory.length > 10) { // Keep only last 10 turns (pairs of user/assistant messages)
      conversationHistory = conversationHistory.slice(-10);
    }

    messageInput.value = '';

    try {
      const llmResponseText = await getLLMResponse(conversationHistory); // Pass history to getLLMResponse
      displayLLMMessage(llmResponseText);

      // Add LLM response to conversation history
      const llmResponseContent = { role: 'model', parts: [{ text: llmResponseText }] };
      conversationHistory.push(llmResponseContent);
      if (conversationHistory.length > 10) { // Keep history size limited
        conversationHistory = conversationHistory.slice(-10);
      }

    } catch (error) {
      displayErrorMessage("Error communicating with Vicky. Please try again later.");
      console.error("Error fetching LLM response:", error);
    } finally {
      // Optional loading state handling
    }
  }

  function displayUserMessage(text) {
    const messageDiv = document.createElement('div');
    messageDiv.classList.add('message', 'user-message');
    messageDiv.textContent = text;
    chatDisplay.appendChild(messageDiv);
    scrollToBottom();
  }

  function displayLLMMessage(text) {
    const messageDiv = document.createElement('div');
    messageDiv.classList.add('message', 'llm-message');
    messageDiv.innerHTML = text;
    chatDisplay.appendChild(messageDiv);
    scrollToBottom();

    // **Check if it's a system message - if so, don't show pop-up**
    if (messageDiv.classList.contains('system-message')) {
      return; // Exit the function early, don't process pop-up
    }

    // **Parse Follow-up Questions & Display in Popup (only for non-system messages)**
    const separator = "***\n\nFollow-up Questions:\n***";
    const parts = text.split(separator);
    const suggestionText = parts.length > 1 ? parts[1] : null;

    if (suggestionText) {
      const followUpQuestions = suggestionText.trim().split('\n')
                                          .map(q => q.replace(/^\d+\.\s*Follow-up Question:\s*/, '').trim())
                                          .filter(q => q);

      if (followUpQuestions.length > 0) {
        followUpQuestionList.innerHTML = ''; // Clear previous questions
        followUpQuestions.forEach(question => {
          const listItem = document.createElement('li');
          listItem.textContent = question;
          listItem.addEventListener('click', () => {
            messageInput.value = question;
            sendMessage();
            followUpPopup.style.display = "none"; // Close popup after question selected
          });
          followUpQuestionList.appendChild(listItem);
        });
        followUpPopup.style.display = "block"; // Show the popup
      }
    }
  }

  function displayErrorMessage(message) {
    const errorDiv = document.createElement('div');
    errorDiv.classList.add('message', 'llm-message', 'error-message');
    errorDiv.textContent = message;
    chatDisplay.appendChild(errorDiv);
    scrollToBottom();
  }

  async function getLLMResponse(history) { // Now accepts 'history' as argument
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;

    // **Include Conversation History in API Request**
    const requestBody = {
      contents: history // Send the conversation history directly in 'contents'
    };

    const response = await fetch(apiUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(requestBody)
    });

    if (!response.ok) {
      const errorData = await response.json();
      let errorMessage = `HTTP error! status: ${response.status}`;
      if (errorData && errorData.error && errorData.error.message) {
        errorMessage += ` - API Error: ${errorData.error.message}`;
      }
      throw new Error(errorMessage);
    }

    const data = await response.json();
    if (data && data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0] && data.candidates[0].content.parts[0].text) {
      return data.candidates[0].content.parts[0].text;
    } else {
      throw new Error("Unexpected API response format: " + JSON.stringify(data));
    }
  }

  function scrollToBottom() {
    chatDisplay.scrollTop = chatDisplay.scrollHeight;
  }
</script>
